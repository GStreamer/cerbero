# This file contains the default configuration to compile for iPhoneOS
# platforms. It contains sensitive enviroment configuration that
# shouldn't be modified unless you know what you are doing.
# PLEASE, DO NOT EDIT THIS FILE

import os
from cerbero.utils import shell
from cerbero.config import Architecture, DistroVersion
from cerbero.errors import FatalError

variants += ['nopython', 'notestspackage']

# We don't want anything from macports detected in configure and
# used later. System libs are passed through the -isysroot option
allow_system_libs=False

ios_min_version = ios_min_version or '8.0'

if target_distro_version == distro_version:
    target_distro_version = None

if target_arch in [Architecture.X86, Architecture.X86_64]:
    ios_platform = 'iPhoneSimulator'
else:
    ios_platform = 'iPhoneOS'

iphone_platform = '/Applications/Xcode.app/Contents/Developer/Platforms/%s.platform/Developer' % ios_platform
_toolchain_root = '%s/usr/bin' % iphone_platform

# Find the installed SDK
_sdk_version = None
for d,v in [
            (DistroVersion.IOS_11_2, '11.2'),
            (DistroVersion.IOS_11_1, '11.1'),
            (DistroVersion.IOS_11_0, '11.0'),
            (DistroVersion.IOS_10_3, '10.3'),
            (DistroVersion.IOS_10_2, '10.2'),
            (DistroVersion.IOS_10_1, '10.1'),
            (DistroVersion.IOS_10_0, '10.0'),
            (DistroVersion.IOS_9_3, '9.3'),
            (DistroVersion.IOS_9_2, '9.2'),
            (DistroVersion.IOS_9_1, '9.1'),
            (DistroVersion.IOS_9_0, '9.0'),
            (DistroVersion.IOS_8_4, '8.4'),
            (DistroVersion.IOS_8_3, '8.3'),
            (DistroVersion.IOS_8_2, '8.2'),
            (DistroVersion.IOS_8_1, '8.1'),
            (DistroVersion.IOS_8_0, '8.0')]:
  sysroot = os.path.join(iphone_platform, 'SDKs', '%s%s.sdk' %(ios_platform, v))
  if os.path.exists (sysroot):
     _sdk_version = d
     break

if target_distro_version is not None and target_distro_version != _sdk_version:
    raise FatalError("The SDK for %s is not installed" % target_distro_version)
elif _sdk_version is None:
    raise FatalError("The SDK for iOS could not be found in your system")
else:
    target_distro_version = _sdk_version


ccache = use_ccache and 'ccache ' or ''
extra_cflags='-Wall -g -Os'
extra_ldflags='-Wno-error=unused-command-line-argument'
if target_arch == Architecture.ARM64:
    arch_cflags = ' -arch arm64 -pipe'
    host = 'aarch64-apple-darwin10'
elif target_arch == Architecture.ARMv7S:
    arch_cflags = ' -arch armv7s -mcpu=cortex-a9 -pipe'
    host = 'arm-apple-darwin10'
elif target_arch == Architecture.ARMv7:
    arch_cflags = ' -arch armv7 -mcpu=cortex-a8 -pipe'
    host = 'arm-apple-darwin10'
elif target_arch == Architecture.ARM:
    arch_cflags = ' -arch armv6 -mcpu=arm1176jzf-s -pipe'
    host = 'arm-apple-darwin10'
elif target_arch == Architecture.X86:
    arch_cflags = ' -arch i386 '
    host = 'i386-apple-darwin10'
elif target_arch == Architecture.X86_64:
    arch_cflags = ' -arch x86_64 '
    host = 'x86_64-apple-darwin10'
elif target_arch == Architecture.UNIVERSAL:
    arch_cflags=''
else:
  raise FatalError("Arch %s not supported" % target_arch)

# Toolchain environment
os.environ['CC']= 'clang'
os.environ['CXX']= 'clang++'
extra_cflags += ' -Wno-error=format-nonliteral -Wno-error=implicit-function-declaration '

os.environ['PATH'] = '%s:%s' % (_toolchain_root, os.environ['PATH'])
os.environ['OBJC'] = os.environ['CC']
os.environ['CPP']= "%s -E" % os.environ['CC']
os.environ['CXXPP']= os.environ['CPP']
os.environ['LD']= 'ld'
os.environ['AR']= 'ar'
os.environ['NM']= 'nm'
os.environ['NMEDIT']= 'nmedit'
os.environ['RANLIB']= 'ranlib'
os.environ['CPPFLAGS'] = '{} -isysroot {} '.format(arch_cflags, sysroot)
os.environ['CFLAGS'] = os.environ['CPPFLAGS']
os.environ['LDFLAGS'] = os.environ['CPPFLAGS']
if ios_platform == 'iPhoneOS':
  os.environ['CFLAGS'] += '-miphoneos-version-min={} '.format(ios_min_version)
  os.environ['LDFLAGS'] += '-miphoneos-version-min={0} -Wl,-iphoneos_version_min,{0} '.format(ios_min_version)
else:
  os.environ['CFLAGS'] += '-mios-simulator-version-min={} '.format(ios_min_version)
  os.environ['LDFLAGS'] += '-mios-simulator-version-min={0} -Wl,-ios_simulator_version_min,{0} '.format(ios_min_version)
os.environ['CFLAGS'] += extra_cflags
os.environ['LDFLAGS'] += '-Wl,-undefined,error -Wl,-headerpad_max_install_names ' + extra_ldflags
os.environ['OBJCFLAGS'] = os.environ['CFLAGS']
os.environ['OBJLDFLAGS'] = os.environ['LDFLAGS']
os.environ['CXXFLAGS'] = os.environ['CFLAGS']

os.environ['AS']= 'as'
if target_arch in [Architecture.X86, Architecture.X86_64]:
    os.environ.pop('GAS', None)
else:
    os.environ['GAS']= '%s %s %s' % ('gas-preprocessor.pl', os.environ['CC'], os.environ['CFLAGS'])


macosx_headers = '/Applications/Xcode.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs/MacOSX.sdk/usr/include'
for missing_header in ["bzlib.h", "crt_externs.h"]:
    missing_path = os.path.join(sysroot, "usr", "include", missing_header)
    if not os.path.lexists(missing_path):
        # FIXME This is not smart especially as we need to sudo
        print "We need to create a syslink between %s and %s as they are missing in the device SDK" %(os.path.join(macosx_headers, missing_header), missing_path)
        shell.call("sudo ln -s %s %s" %(os.path.join(macosx_headers, missing_header), missing_path))


if use_ccache:
    os.environ['CC'] = 'ccache  %s' % os.environ['CC']
    os.environ['CXX'] = 'ccache  %s' % os.environ['CXX']

# For GLib
os.environ['glib_cv_stack_grows'] = 'yes'
os.environ['glib_cv_uscore'] = 'no'
os.environ['ac_cv_func_posix_getpwuid_r'] = 'yes'
os.environ['ac_cv_func_posix_getgrgid_r'] = 'yes'
os.environ['gt_cv_c_wchar_t'] = 'no'
os.environ['ac_cv_func__NSGetEnviron'] = 'no'

# For pixman
os.environ['ac_cv_tls'] = 'none'

# Workaround for https://openradar.appspot.com/22671534 on 10.11.
os.environ['gl_cv_func_getcwd_abort_bug'] = 'no'
