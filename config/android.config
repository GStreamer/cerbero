# This file contains the default configuration to compile for Android
# platforms. It contains sensitive enviroment configuration that
# shouldn't be modified unless you know what you are doing.
# PLEASE, DO NOT EDIT THIS FILE

import os
from cerbero.config import Architecture, DistroVersion
from cerbero.errors import FatalError
import cerbero.utils.messages as m

# So, paths:
#
# With NDK r16, 'Unified Headers' is the only way to build against the NDK and
# the API-level specific headers are not shipped anymore.  A migration guide is
# available from https://android.googlesource.com/platform/ndk/+/ndk-release-r16/docs/UnifiedHeaders.md
# and we follow that when setting up these paths.  One thing to note however
# is that the 'Unified Headers' ship headers that contain API-level guarded
# functions so we may need to replace or override headers.  One such example
# is iconv.h which at the time of writing, has a header in the NDK
# with no usable functions.  This simply means that we have to construct 
# cflags/cppflags/ldflags/etc to look in our directories before looking into
# the sysroot.
#
# toolchain_prefix: NDK location
# toolchain_path: location of the compiler binaries
# sysroot: location of the API-level libraries (no headers)
# isysroot: location of the headers

variants += ['nopython', 'notestspackage']

# We don't want anything from linux system to be used on android :)
allow_system_libs=False

if not toolchain_prefix:
    toolchain_prefix = os.path.join(home_dir, 'android-ndk-16')

toolchain_path = None
toolchain_version = None

if target_arch == Architecture.ARM or target_arch == Architecture.ARMv7:
    tools_prefix = 'arm-linux-androideabi'
    host = "arm-linux-androideabi"
    _arch = 'arm'

    for tc_version in ['4.9', '4.8', '4.7', '4.6']:
        for tc_arch in ['darwin-x86', 'darwin-x86_64', 'linux-x86', 'linux-x86_64']:
            tmp = '%s/toolchains/arm-linux-androideabi-%s/prebuilt/%s/bin' % (toolchain_prefix, tc_version, tc_arch)
            if os.path.exists(tmp):
                toolchain_path = tmp
                toolchain_version = tc_version
                break
        if toolchain_path:
            break
elif target_arch == Architecture.ARM64:
    tools_prefix = 'aarch64-linux-android'
    host = "aarch64-linux-android"
    _arch = 'arm64'

    for tc_version in ['4.9', '4.8', '4.7', '4.6']:
        for tc_arch in ['darwin-x86', 'darwin-x86_64', 'linux-x86', 'linux-x86_64']:
            tmp = '%s/toolchains/aarch64-linux-android-%s/prebuilt/%s/bin' % (toolchain_prefix, tc_version, tc_arch)
            if os.path.exists(tmp):
                toolchain_path = tmp
                toolchain_version = tc_version
                break
        if toolchain_path:
            break
elif target_arch == Architecture.X86:
    tools_prefix = 'i686-linux-android'
    host = "i686-linux-android"
    _arch = 'x86'
    for tc_version in ['4.9', '4.8', '4.7', '4.6']:
        for tc_arch in ['darwin-x86', 'darwin-x86_64', 'linux-x86', 'linux-x86_64']:
            tmp = '%s/toolchains/x86-%s/prebuilt/%s/bin' % (toolchain_prefix, tc_version, tc_arch)
            if os.path.exists(tmp):
                toolchain_path = tmp
                toolchain_version = tc_version
                break
        if toolchain_path:
            break
elif target_arch == Architecture.X86_64:
    tools_prefix = 'x86_64-linux-android'
    host = "x86_64-linux-android"
    _arch = 'x86_64'
    for tc_version in ['4.9', '4.8', '4.7', '4.6']:
        for tc_arch in ['darwin-x86', 'darwin-x86_64', 'linux-x86', 'linux-x86_64']:
            tmp = '%s/toolchains/x86_64-%s/prebuilt/%s/bin' % (toolchain_prefix, tc_version, tc_arch)
            if os.path.exists(tmp):
                toolchain_path = tmp
                toolchain_version = tc_version
                break
        if toolchain_path:
            break
elif target_arch == Architecture.UNIVERSAL:
    _arch = ''
    tools_prefix = ''
    toolchain_path = '.'
else:
  raise FatalError("Arch %s not supported" % target_arch)

if not toolchain_path:
  m.warning ("Android NDK not found")

v = DistroVersion.get_android_api_version(target_distro_version)

isysroot = "%s/sysroot" % (toolchain_prefix)
sysroot = "%s/platforms/android-%d/arch-%s" % (toolchain_prefix, v, _arch)

# Default compiler flags
os.environ['CFLAGS'] = '-Wall -g -Os '
os.environ['CXXFLAGS'] = '-Wall -g -Os '
os.environ['OBJCFLAGS'] = '-Wall -g -Os '

# 'universal' is set by cerbero itself when building under a universal regime
# so that we can construct different paths to include/lib directories to where
# they actually are.  Without this we don't know where the headers/libs will
# actually end up
if 'universal' in variants:
    incl_dir = os.path.join(prefix, _arch, 'include')
    lib_dir = os.path.join(prefix, _arch, 'lib')
else:
    incl_dir = os.path.join(prefix, 'include')
    lib_dir = os.path.join(prefix, 'lib')
if target_arch != Architecture.UNIVERSAL and not os.path.exists(incl_dir):
    os.makedirs(incl_dir)
if target_arch != Architecture.UNIVERSAL and not os.path.exists(lib_dir):
    os.makedirs(lib_dir)

ccache = use_ccache and 'ccache ' or ''
defines = '-DANDROID -DPIC -D__ANDROID_API__=%s ' % (v)
# Android API older than 21 does not work well with -D_FILE_OFFSET_BITS=64,
# which is set by default in Meson. We must remove this when we move to
# building with Clang.
if v < 21:
    defines += '-U_FILE_OFFSET_BITS '
cflags = '-isysroot %s -isystem %s -isystem %s/usr/include -isystem %s/usr/include/%s -ffunction-sections -funwind-tables -fstack-protector -no-canonical-prefixes -fPIC' % (isysroot, incl_dir, isysroot, isysroot, tools_prefix)
ldflags = '--sysroot %s -fPIC -no-canonical-prefixes -Wl,-no-undefined -Wl,-z,noexecstack -Wl,-z,relro -Wl,-z,now -Wl,--gc-sections -Wl,-dynamic-linker,/system/bin/linker ' % (sysroot)
if not target_arch in [Architecture.ARM64, Architecture.X86_64]:
   # nocopyreloc causes broken linking on arm64
   ldflags += ' -Wl,-z,nocopyreloc '
if target_arch in [Architecture.X86_64]:
   ldflags += ' -L%s/usr/lib64 ' % sysroot
else:
   ldflags += ' -L%s/usr/lib ' % sysroot

ldvariant = 'gold'
ldflags += ' -fuse-ld=%s ' % ldvariant
ldflags += ' -L%s' % (lib_dir,)

# from android-ndk-r8b/toolchains/$NAME-$VERSION/setup.mk
if target_arch in [Architecture.ARM, Architecture.ARMv7, Architecture.ARM64]:
    if target_arch == Architecture.ARM:
        defines += ' -D__ARM_ARCH_5__ -D__ARM_ARCH_5T__ -D__ARM_ARCH_5E__ -D__ARM_ARCH_5TE__ '
        cflags += ' -mthumb -march=armv5te -mtune=xscale -msoft-float'
    elif target_arch == Architecture.ARMv7:
        defines += ' -D__ARM_ARCH_7A__ '
        cflags += ' -mthumb -march=armv7-a -mfloat-abi=softfp -mfpu=vfpv3-d16'
        ldflags += "-march=armv7-a -Wl,--fix-cortex-a8 "
elif target_arch == Architecture.X86:
    cflags += ' -march=i686 '

# Toolchain environment
os.environ['CPPFLAGS'] = '-isysroot %s -isystem %s -isystem %s/usr/include -isystem %s/usr/include/%s %s' % (isysroot, incl_dir, isysroot, isysroot, tools_prefix, defines)
os.environ['CFLAGS'] += "%s %s -Wa,--noexecstack" % (cflags, defines)
os.environ['CXXFLAGS'] = os.environ['CFLAGS'] + ' -fno-rtti -fno-exceptions'
os.environ['LDFLAGS'] = '%s' % (ldflags,)

def cmd(command):
    return '%s-%s' % (tools_prefix, command)

os.environ['CC']= '%s%s' % (ccache, cmd('gcc'))
os.environ['CXX']= '%s%s' % (ccache, cmd('g++'))
os.environ['LD']= cmd('ld.%s' % ldvariant)
os.environ['CPP']= cmd('cpp')
os.environ['RANLIB']= cmd('ranlib')
os.environ['AR']= cmd('ar')
os.environ['AS']= cmd('as')
os.environ['NM']= cmd('nm')
os.environ['STRIP']= cmd('strip')
os.environ['OBJCOPY']= cmd('objcopy')

os.environ['PATH'] = '%s:%s:%s' % (toolchain_prefix, toolchain_path, os.environ['PATH'])
# For the libc.so dependency in i686-linux-android-as
if target_arch == Architecture.X86:
    extra_lib_path = '%s/usr/lib' % (sysroot)
elif target_arch == Architecture.X86_64:
    extra_lib_path = '%s/usr/lib64' % (sysroot)


# For GLib
os.environ['glib_cv_stack_grows'] = 'yes'
os.environ['glib_cv_uscore'] = 'no'
os.environ['ac_cv_func_posix_getpwuid_r'] = 'no'
os.environ['ac_cv_func_nonposix_getpwuid_r'] = 'no'
os.environ['ac_cv_func_posix_getgrgid_r'] = 'no'
os.environ['ac_cv_func_nonposix_getgrgid_r'] = 'no'

# For cairo
# FIXME : IF WE ADD BIG-ENDIAN PLATFORMS, FIX THIS !
os.environ['ax_cv_c_float_words_bigendian'] = 'no'

#No, really, it doesn't have uselocale
os.environ['ac_cv_func_uselocale'] = 'no'
