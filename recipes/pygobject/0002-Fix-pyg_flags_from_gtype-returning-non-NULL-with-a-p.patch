From fd8c4181c88f2283087ded6df024b54b0667ade6 Mon Sep 17 00:00:00 2001
From: Nirbheek Chauhan <nirbheek@centricular.com>
Date: Fri, 6 Feb 2026 13:14:56 +0530
Subject: [PATCH 2/2] Fix pyg_flags_from_gtype returning non-NULL with a
 pending exception

pyg_flags_from_gtype() checks PyErr_Occurred() at entry and returns
PyLong_FromUnsignedLong(0) if an exception is pending. This returns a
valid non-NULL result without clearing the exception, violating the
Python C API contract and causing Python to raise:

  SystemError: returned a result with an exception set

Return NULL instead to properly propagate the pending exception.
---
 gi/pygflags.c | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/gi/pygflags.c b/gi/pygflags.c
index df1280f9..dfa1a176 100644
--- a/gi/pygflags.c
+++ b/gi/pygflags.c
@@ -209,7 +209,7 @@ pyg_flags_from_gtype (GType gtype, guint value)
     PyObject *pyclass, *values, *retval, *pyint;
 
     if (PyErr_Occurred())
-        return PyLong_FromUnsignedLong (0);
+        return NULL;
 
     g_return_val_if_fail(gtype != G_TYPE_INVALID, NULL);
 
-- 
2.52.0

