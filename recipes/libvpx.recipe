# -*- Mode: Python -*- vi:si:et:sw=4:sts=4:ts=4:syntax=python


class Recipe(recipe.Recipe):
    name = 'libvpx'
    version = 'v1.1.0'
    licenses = [License.BSD]
    configure_tpl = "%(config-sh)s --prefix=%(prefix)s "\
                    "--libdir=%(libdir)s %(options)s"
    configure_options = "--enable-pic --as=yasm "
    add_host_build_target = False
    supports_cache_variables = False
    can_use_configure_cache = False

    files_libs = ['libvpx']
    files_bins = ['vpxenc', 'vpxdec']
    files_devel = ['include/vpx', 'lib/pkgconfig/vpx.pc']

    # libvpx does not have check target
    make_check = None


    def prepare (self):
        if self.config.target_arch == Architecture.X86_64:
            arch = 'x86_64'
        elif self.config.target_arch == Architecture.X86:
            arch = 'x86'
        elif self.config.target_arch == Architecture.PPC:
            arch = 'ppc32'
        elif self.config.target_arch == Architecture.ARM:
            arch = 'arm'

        if self.config.target_platform == Platform.DARWIN:
            if self.config.target_distro_version in [DistroVersion.OS_X_MOUNTAIN_LION, DistroVersion.OS_X_LION] and arch != 'x86':
                platform = 'darwin11'
            else:
                platform = 'darwin10'
            if self.config.target_arch == Architecture.PPC:
                platform = 'darwin9'

        elif self.config.target_platform == Platform.WINDOWS:
            self.config_sh = 'LD=$CC ./configure'
            if self.config.target_arch == Architecture.X86_64:
                platform = 'win64'
            else:
                platform = 'win32'
        # FIXME:
        elif self.config.target_platform == Platform.ANDROID:
            arch = 'armv5te'
            platform = 'android'
            self.config_sh = 'LD=$CC ./configure'
            self.configure_options.replace('--as=yasm', '')
            self.configure_options += ' --disable-runtime-cpu-detect --sdk-path=%s ' % self.config.toolchain_prefix
            # Fix compiler error with -mthumb
            self.new_env['CFLAGS'] = os.environ['CFLAGS'].replace('-mthumb', '')
        else:
            self.configure_options += '--enable-shared '
            platform = 'linux'

        self.configure_options += ' --target=%s-%s-gcc ' % (arch, platform)
