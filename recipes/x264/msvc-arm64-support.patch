From d8efdd7282e10f1d5d6af5c5d0677748dbb53714 Mon Sep 17 00:00:00 2001
From: Nirbheek Chauhan <nirbheek@centricular.com>
Date: Thu, 25 Dec 2025 03:42:39 +0530
Subject: [PATCH 1/6] meson: Fix missing outputname for non-x86 MSVC assembly

---
 meson.build | 9 ++++-----
 1 file changed, 4 insertions(+), 5 deletions(-)

diff --git a/meson.build b/meson.build
index 49b7c936..152632da 100644
--- a/meson.build
+++ b/meson.build
@@ -533,12 +533,11 @@ if not get_option('debug')
 endif
 
 asm_gen_objs = []
+outputname = '@BASENAME@.o'
+if host_system == 'windows'
+  outputname = '@BASENAME@.obj'
+endif
 if ['x86', 'x86_64'].contains(host_cpu) and nasm.found()
-  outputname = '@BASENAME@.o'
-  if host_system == 'windows'
-    outputname = '@BASENAME@.obj'
-  endif
-
   if host_cpu == 'x86' or host_cpu == 'x86_64'
     if host_cpu == 'x86'
       asm_x = files('common/x86/dct-32.asm',
-- 
2.51.0.windows.1


From 8c98d3b03a99213908304513f671d38c4ffeba37 Mon Sep 17 00:00:00 2001
From: Nirbheek Chauhan <nirbheek@centricular.com>
Date: Thu, 25 Dec 2025 03:37:27 +0530
Subject: [PATCH 2/6] meson: Use armasm64 on MSVC aarch64

---
 meson.build | 4 ++--
 1 file changed, 2 insertions(+), 2 deletions(-)

diff --git a/meson.build b/meson.build
index 152632da..79139620 100644
--- a/meson.build
+++ b/meson.build
@@ -242,9 +242,9 @@ elif host_cpu == 'aarch64'
     endif
   elif host_system == 'windows'
     nasm = find_program('tools/gas-preprocessor.pl', required: asm)
-    armasm = find_program('armasm', required: asm)
+    armasm64 = find_program('armasm64', required: asm)
     if compiler_style == 'MS'
-      asflags += ['-arch', 'aarch64', '-as-type', 'armasm', '-force-thumb', '--', armasm, '-nologo']
+      asflags += ['-arch', 'aarch64', '-as-type', 'armasm', '-force-thumb', '--', armasm64, '-nologo']
     endif
   endif
 elif host_cpu == 'arm'
-- 
2.51.0.windows.1


From 6bfc1cef3934f21fd5a186ac43d5e192a7d6999b Mon Sep 17 00:00:00 2001
From: Nirbheek Chauhan <nirbheek@centricular.com>
Date: Thu, 25 Dec 2025 03:38:23 +0530
Subject: [PATCH 3/6] meson: generator arguments can only contain strings

---
 meson.build | 6 +++---
 1 file changed, 3 insertions(+), 3 deletions(-)

diff --git a/meson.build b/meson.build
index 79139620..b87d1538 100644
--- a/meson.build
+++ b/meson.build
@@ -244,14 +244,14 @@ elif host_cpu == 'aarch64'
     nasm = find_program('tools/gas-preprocessor.pl', required: asm)
     armasm64 = find_program('armasm64', required: asm)
     if compiler_style == 'MS'
-      asflags += ['-arch', 'aarch64', '-as-type', 'armasm', '-force-thumb', '--', armasm64, '-nologo']
+      asflags += ['-arch', 'aarch64', '-as-type', 'armasm', '-force-thumb', '--', armasm64.full_path(), '-nologo']
     endif
   endif
 elif host_cpu == 'arm'
   if host_system == 'windows' and compiler_style == 'MS'
     nasm = find_program('tools/gas-preprocessor.pl', required: asm)
     armasm = find_program('armasm', required: asm)
-    asflags += ['-arch', 'arm', '-as-type', 'armasm', '-force-thumb', '--', armasm, '-nologo', '-ignore', '4509']
+    asflags += ['-arch', 'arm', '-as-type', 'armasm', '-force-thumb', '--', armasm.full_path(), '-nologo', '-ignore', '4509']
   elif host_system == 'windows'
     # FIXME once Meson exposes the compiler command line
     nasm = find_program('tools/gas-preprocessor.pl', required: asm)
@@ -261,7 +261,7 @@ elif host_cpu == 'arm'
     else
       gcc = find_program('gcc', required: asm)
     endif
-    asflags += ['-arch', 'arm', '-as-type', 'clang', '-force-thumb', '--', gcc, '-mimplicit-it=always']
+    asflags += ['-arch', 'arm', '-as-type', 'clang', '-force-thumb', '--', gcc.full_path(), '-mimplicit-it=always']
   endif
 endif
 
-- 
2.51.0.windows.1


From 917568956e0f27c52749bf4ce4500d0d9f8a165d Mon Sep 17 00:00:00 2001
From: Nirbheek Chauhan <nirbheek@centricular.com>
Date: Thu, 25 Dec 2025 03:39:18 +0530
Subject: [PATCH 4/6] meson: asflags must be prepended with gas-preprocessor

-D/-U flags aren't understood by gas-preprocessor. Those must be
passed to the assembler, which means they must come at the end.
---
 meson.build | 6 +++---
 1 file changed, 3 insertions(+), 3 deletions(-)

diff --git a/meson.build b/meson.build
index b87d1538..c129406d 100644
--- a/meson.build
+++ b/meson.build
@@ -244,14 +244,14 @@ elif host_cpu == 'aarch64'
     nasm = find_program('tools/gas-preprocessor.pl', required: asm)
     armasm64 = find_program('armasm64', required: asm)
     if compiler_style == 'MS'
-      asflags += ['-arch', 'aarch64', '-as-type', 'armasm', '-force-thumb', '--', armasm64.full_path(), '-nologo']
+      asflags = ['-arch', 'aarch64', '-as-type', 'armasm', '-force-thumb', '--', armasm64.full_path(), '-nologo'] + asflags
     endif
   endif
 elif host_cpu == 'arm'
   if host_system == 'windows' and compiler_style == 'MS'
     nasm = find_program('tools/gas-preprocessor.pl', required: asm)
     armasm = find_program('armasm', required: asm)
-    asflags += ['-arch', 'arm', '-as-type', 'armasm', '-force-thumb', '--', armasm.full_path(), '-nologo', '-ignore', '4509']
+    asflags = ['-arch', 'arm', '-as-type', 'armasm', '-force-thumb', '--', armasm.full_path(), '-nologo', '-ignore', '4509'] + asflags
   elif host_system == 'windows'
     # FIXME once Meson exposes the compiler command line
     nasm = find_program('tools/gas-preprocessor.pl', required: asm)
@@ -261,7 +261,7 @@ elif host_cpu == 'arm'
     else
       gcc = find_program('gcc', required: asm)
     endif
-    asflags += ['-arch', 'arm', '-as-type', 'clang', '-force-thumb', '--', gcc.full_path(), '-mimplicit-it=always']
+    asflags = ['-arch', 'arm', '-as-type', 'clang', '-force-thumb', '--', gcc.full_path(), '-mimplicit-it=always'] + asflags
   endif
 endif
 
-- 
2.51.0.windows.1


From d4860078fba05204dc26568cc97bf20eafb32d9c Mon Sep 17 00:00:00 2001
From: Nirbheek Chauhan <nirbheek@centricular.com>
Date: Thu, 25 Dec 2025 03:40:46 +0530
Subject: [PATCH 5/6] meson: Include current directory in GAS for config.h

---
 meson.build | 6 +++---
 1 file changed, 3 insertions(+), 3 deletions(-)

diff --git a/meson.build b/meson.build
index c129406d..911d02f4 100644
--- a/meson.build
+++ b/meson.build
@@ -244,14 +244,14 @@ elif host_cpu == 'aarch64'
     nasm = find_program('tools/gas-preprocessor.pl', required: asm)
     armasm64 = find_program('armasm64', required: asm)
     if compiler_style == 'MS'
-      asflags = ['-arch', 'aarch64', '-as-type', 'armasm', '-force-thumb', '--', armasm64.full_path(), '-nologo'] + asflags
+      asflags = ['-arch', 'aarch64', '-as-type', 'armasm', '-force-thumb', '--', armasm64.full_path(), '-nologo', '-I.'] + asflags
     endif
   endif
 elif host_cpu == 'arm'
   if host_system == 'windows' and compiler_style == 'MS'
     nasm = find_program('tools/gas-preprocessor.pl', required: asm)
     armasm = find_program('armasm', required: asm)
-    asflags = ['-arch', 'arm', '-as-type', 'armasm', '-force-thumb', '--', armasm.full_path(), '-nologo', '-ignore', '4509'] + asflags
+    asflags = ['-arch', 'arm', '-as-type', 'armasm', '-force-thumb', '--', armasm.full_path(), '-nologo', '-ignore', '4509', '-I.'] + asflags
   elif host_system == 'windows'
     # FIXME once Meson exposes the compiler command line
     nasm = find_program('tools/gas-preprocessor.pl', required: asm)
@@ -261,7 +261,7 @@ elif host_cpu == 'arm'
     else
       gcc = find_program('gcc', required: asm)
     endif
-    asflags = ['-arch', 'arm', '-as-type', 'clang', '-force-thumb', '--', gcc.full_path(), '-mimplicit-it=always'] + asflags
+    asflags = ['-arch', 'arm', '-as-type', 'clang', '-force-thumb', '--', gcc.full_path(), '-mimplicit-it=always', '-I.'] + asflags
   endif
 endif
 
-- 
2.51.0.windows.1


From aaa7d61f91fc9c01269e88ef682fbf914bb5aad0 Mon Sep 17 00:00:00 2001
From: Nirbheek Chauhan <nirbheek@centricular.com>
Date: Thu, 25 Dec 2025 03:42:02 +0530
Subject: [PATCH 6/6] meson: Don't force thumb with armasm

armasm doesn't understand thumb instructions afaict.
---
 meson.build | 4 ++--
 1 file changed, 2 insertions(+), 2 deletions(-)

diff --git a/meson.build b/meson.build
index 911d02f4..ac60ee19 100644
--- a/meson.build
+++ b/meson.build
@@ -244,14 +244,14 @@ elif host_cpu == 'aarch64'
     nasm = find_program('tools/gas-preprocessor.pl', required: asm)
     armasm64 = find_program('armasm64', required: asm)
     if compiler_style == 'MS'
-      asflags = ['-arch', 'aarch64', '-as-type', 'armasm', '-force-thumb', '--', armasm64.full_path(), '-nologo', '-I.'] + asflags
+      asflags = ['-arch', 'aarch64', '-as-type', 'armasm', '--', armasm64.full_path(), '-nologo', '-I.'] + asflags
     endif
   endif
 elif host_cpu == 'arm'
   if host_system == 'windows' and compiler_style == 'MS'
     nasm = find_program('tools/gas-preprocessor.pl', required: asm)
     armasm = find_program('armasm', required: asm)
-    asflags = ['-arch', 'arm', '-as-type', 'armasm', '-force-thumb', '--', armasm.full_path(), '-nologo', '-ignore', '4509', '-I.'] + asflags
+    asflags = ['-arch', 'arm', '-as-type', 'armasm', '--', armasm.full_path(), '-nologo', '-ignore', '4509', '-I.'] + asflags
   elif host_system == 'windows'
     # FIXME once Meson exposes the compiler command line
     nasm = find_program('tools/gas-preprocessor.pl', required: asm)
-- 
2.51.0.windows.1

