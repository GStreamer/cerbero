From b04964ab050229c31b76150c157152420358bc1e Mon Sep 17 00:00:00 2001
From: Fernando Jimenez <fjimenez@igalia.com>
Date: Tue, 16 Feb 2021 06:09:31 +0100
Subject: [PATCH] Implement Android WebProcess and NetworkProcess entry points

---
 .../soup/NetworkProcessMainSoup.cpp           | 28 ++++++++++---------
 .../WebProcess/wpe/WebProcessMainWPE.cpp      | 14 ++++++++++
 Source/WebKit/webkitglib-symbols.map          |  1 +
 3 files changed, 30 insertions(+), 13 deletions(-)

diff --git a/Source/WebKit/NetworkProcess/soup/NetworkProcessMainSoup.cpp b/Source/WebKit/NetworkProcess/soup/NetworkProcessMainSoup.cpp
index 0d31b3d1..a5b8e6fc 100644
--- a/Source/WebKit/NetworkProcess/soup/NetworkProcessMainSoup.cpp
+++ b/Source/WebKit/NetworkProcess/soup/NetworkProcessMainSoup.cpp
@@ -29,32 +29,34 @@
 
 #include "AuxiliaryProcessMain.h"
 #include "NetworkProcess.h"
-#include <WebCore/NetworkStorageSession.h>
 
 namespace WebKit {
 
 static RefPtr<NetworkProcess> globalNetworkProcess;
 
-class NetworkProcessMainSoup final: public AuxiliaryProcessMainBase {
-public:
-    void platformFinalize() override
-    {
-        // Needed to destroy the SoupSession and SoupCookieJar, e.g. to avoid
-        // leaking SQLite temporary journaling files.
-        globalNetworkProcess->destroySession(PAL::SessionID::defaultSessionID());
-    }
-};
-
 template<>
 void initializeAuxiliaryProcess<NetworkProcess>(AuxiliaryProcessInitializationParameters&& parameters)
 {
     static NeverDestroyed<NetworkProcess> networkProcess(WTFMove(parameters));
     globalNetworkProcess = &networkProcess.get();
 }
-    
+
 int NetworkProcessMain(int argc, char** argv)
 {
-    return AuxiliaryProcessMain<NetworkProcess, NetworkProcessMainSoup>(argc, argv);
+    return AuxiliaryProcessMain<NetworkProcess, AuxiliaryProcessMainBase>(argc, argv);
 }
 
 } // namespace WebKit
+
+extern "C" {
+
+__attribute__((visibility("default")))
+int android_NetworkProcess_main(int argc, char** argv)
+{
+    ALOGV("android_NetworkProcess_main() argc %d, argv %p\n", argc, argv);
+    for (int i = 0; i < argc; ++i)
+        ALOGV("  argv[%d] -- %s\n", i, argv[i]);
+    return WebKit::NetworkProcessMain(argc, argv);
+}
+
+}
diff --git a/Source/WebKit/WebProcess/wpe/WebProcessMainWPE.cpp b/Source/WebKit/WebProcess/wpe/WebProcessMainWPE.cpp
index 6fb54a5a..7aa0a4b4 100644
--- a/Source/WebKit/WebProcess/wpe/WebProcessMainWPE.cpp
+++ b/Source/WebKit/WebProcess/wpe/WebProcessMainWPE.cpp
@@ -99,3 +99,17 @@ int WebProcessMain(int argc, char** argv)
 }
 
 } // namespace WebKit
+
+extern "C" {
+
+__attribute__((visibility("default")))
+int android_WebProcess_main(int argc, char** argv)
+{
+    ALOGV("android_WebProcess_main() argc %d, argv %p\n", argc, argv);
+    for (int i = 0; i < argc; ++i)
+        ALOGV("  argv[%d] -- %s\n", i, argv[i]);
+    return WebKit::WebProcessMain(argc, argv);
+}
+
+}
+
diff --git a/Source/WebKit/webkitglib-symbols.map b/Source/WebKit/webkitglib-symbols.map
index cf4b4d93..2e12d385 100644
--- a/Source/WebKit/webkitglib-symbols.map
+++ b/Source/WebKit/webkitglib-symbols.map
@@ -12,6 +12,7 @@ global:
     "WebKit::WebKitExtensionManager::singleton()";
     "WebKit::WebProcessMain(int, char**)";
   };
+  android_*;
 local:
   *;
 };
-- 
2.25.1

