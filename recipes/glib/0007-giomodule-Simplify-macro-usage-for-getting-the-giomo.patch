From 97b8cae1c8872a8183783e5835a1cecd85c12144 Mon Sep 17 00:00:00 2001
From: Nirbheek Chauhan <nirbheek@centricular.com>
Date: Tue, 27 Jan 2026 05:52:20 +0530
Subject: [PATCH 7/8] giomodule: Simplify macro usage for getting the giomodule
 dir

The original code is a bit hard to follow, and has one extra
allocation in the common case on macOS.
---
 gio/giomodule.c | 79 ++++++++++++++++++++++++++++++-------------------
 1 file changed, 48 insertions(+), 31 deletions(-)

diff --git a/gio/giomodule.c b/gio/giomodule.c
index 4fc5154..782d633 100644
--- a/gio/giomodule.c
+++ b/gio/giomodule.c
@@ -70,6 +70,14 @@
 
 #ifdef __APPLE__
 #include <AvailabilityMacros.h>
+#include <TargetConditionals.h>
+
+#if (defined (TARGET_OS_OSX) && TARGET_OS_OSX) || \
+     (!defined (TARGET_OS_OSX) && defined (TARGET_OS_MAC) && TARGET_OS_MAC)
+#define HAVE_MACOS
+#include <dlfcn.h>
+#endif
+
 #endif
 
 #define __GLIB_H_INSIDE__
@@ -1237,12 +1245,9 @@ _g_io_modules_ensure_extension_points_registered (void)
     }
 }
 
-static gchar *
-get_gio_module_dir (void)
+static inline gchar *
+get_gio_module_dir_env (void)
 {
-  gchar *module_dir;
-  gboolean is_setuid = GLIB_PRIVATE_CALL (g_check_setuid) ();
-
   /* If running as setuid, loading modules from an arbitrary directory
    * controlled by the unprivileged user who is running the program could allow
    * for execution of arbitrary code (in constructors in modules).
@@ -1250,7 +1255,42 @@ get_gio_module_dir (void)
    *
    * If a setuid program somehow needs to load additional GIO modules, it should
    * explicitly call g_io_modules_scan_all_in_directory(). */
-  module_dir = !is_setuid ? g_strdup (g_getenv ("GIO_MODULE_DIR")) : NULL;
+  if (GLIB_PRIVATE_CALL (g_check_setuid) ())
+    return NULL;
+
+  return g_strdup (g_getenv ("GIO_MODULE_DIR"));
+}
+
+#ifdef __APPLE__
+static inline gchar *
+get_gio_module_dir_darwin (void)
+{
+/* Only auto-relocate on macOS, not watchOS etc; older macOS SDKs only define TARGET_OS_MAC */
+#ifdef HAVE_MACOS
+  g_autofree gchar *path = NULL;
+  g_autofree gchar *possible_dir = NULL;
+  Dl_info info;
+
+  if (dladdr (get_gio_module_dir_darwin, &info))
+    {
+      /* Gets path to the PREFIX/lib directory */
+      path = g_path_get_dirname (info.dli_fname);
+      possible_dir = g_build_filename (path, "gio", "modules", NULL);
+      if (g_file_test (possible_dir, G_FILE_TEST_IS_DIR))
+        {
+          return g_steal_pointer (&possible_dir);
+        }
+    }
+#endif
+  return g_strdup (GIO_MODULE_DIR);
+}
+#endif
+
+static gchar *
+get_gio_module_dir (void)
+{
+  gchar *module_dir = get_gio_module_dir_env ();
+
   if (module_dir == NULL)
     {
 #ifdef G_OS_WIN32
@@ -1261,33 +1301,10 @@ get_gio_module_dir (void)
                                      "lib", "gio", "modules",
                                      NULL);
       g_free (install_dir);
+#elif defined(__APPLE__)
+      module_dir = get_gio_module_dir_darwin ();
 #else
       module_dir = g_strdup (GIO_MODULE_DIR);
-#ifdef __APPLE__
-#include "TargetConditionals.h"
-/* Only auto-relocate on macOS, not watchOS etc; older macOS SDKs only define TARGET_OS_MAC */
-#if (defined (TARGET_OS_OSX) && TARGET_OS_OSX) || \
-     (!defined (TARGET_OS_OSX) && defined (TARGET_OS_MAC) && TARGET_OS_MAC)
-#include <dlfcn.h>
-      {
-        g_autofree gchar *path = NULL;
-        g_autofree gchar *possible_dir = NULL;
-        Dl_info info;
-
-        if (dladdr (get_gio_module_dir, &info))
-          {
-            /* Gets path to the PREFIX/lib directory */
-            path = g_path_get_dirname (info.dli_fname);
-            possible_dir = g_build_filename (path, "gio", "modules", NULL);
-            if (g_file_test (possible_dir, G_FILE_TEST_IS_DIR))
-              {
-                g_free (module_dir);
-                module_dir = g_steal_pointer (&possible_dir);
-              }
-          }
-      }
-#endif
-#endif
 #endif
     }
 
-- 
2.52.0

