# -*- Mode: Python -*- vi:si:et:sw=4:sts=4:ts=4:syntax=python
from cerbero.utils import shell

class Recipe(recipe.Recipe):
    name = 'wpewebkit'
    version = '2.30.4'
    stype = SourceType.TARBALL
    btype = BuildType.CMAKE
    url = 'https://wpewebkit.org/releases/wpewebkit-stable.tar.xz'
    tarball_checksum = '1e521d85cf8cf344b9fd08eabad7a1d18a330fb7862a77eaf78d7d7b10d5f6ef'
    deps = [
        'cairo',
        'gstreamer-1.0',
        'gst-plugins-base-1.0',
        'gst-plugins-good-1.0',
        'gst-plugins-bad-1.0',
        'harfbuzz',
        'libepoxy',
        'libgcrypt',
        'libsoup',
        'libxslt',
        'libwpe'
    ]
    # TODO: support accessibility, gstreamer-gl and woff2
    configure_options = '-DPORT=WPE -DENABLE_ACCESSIBILITY=OFF \
                        -DUSE_GSTREAMER_GL=OFF -DUSE_WOFF2=OFF \
                        -DUSE_SYSTEMD=OFF -DENABLE_BUBBLEWRAP_SANDBOX=OFF \
                        -DHAVE_PTHREAD_NP_H=OFF \
                        -DCMAKE_SYSTEM_NAME=Linux \
                        -Dis_android=1 \
                        -DENABLE_WEBDRIVER=OFF \
                        -DCMAKE_BUILD_TYPE=RelWithDebInfo -GNinja'

    def prepare(self):
        src_arch = self.config.target_arch
        if self.config.target_platform in (Platform.ANDROID):
            self.deps += ['libwebp']
            if self.config.target_arch == Architecture.ARMv7:
                libarch = "armeabi-v7a"
                src_arch = "arm"
            elif self.config.target_arch == Architecture.ARM:
                libarch = "armeabi"
            elif self.config.target_arch == Architecture.ARM64:
                libarch = "arm64-v8a"
            elif self.config.target_arch == Architecture.X86:
                libarch = "x86"
            elif self.config.target_arch == Architecture.X86_64:
                libarch = "x86_64"
            else:
                raise FatalError("Unsupported Android architecture: " + \
                    self.config.target_arch)
            self.configure_options += ' -DCMAKE_SYSTEM_PROCESSOR={0}'.format(src_arch)
            stl_libdir = os.path.join(self.config.toolchain_prefix, 'libs', libarch)
            self.append_env('LDFLAGS', '-L', stl_libdir, '-landroid', '-llog', '-lm', '-lc++_shared')


    async def compile(self):
        await shell.async_call(['ninja'], cmd_dir=self.build_dir, logfile=self.logfile)
