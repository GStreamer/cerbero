From a3c06c8e61bc8e5f36ad92c9090cb639c1aaa049 Mon Sep 17 00:00:00 2001
From: Nirbheek Chauhan <nirbheek@centricular.com>
Date: Wed, 31 May 2023 01:36:37 +0530
Subject: [PATCH] meson: Update to latest wrap, install required absl headers

---
 meson.build                 | 15 ++++++--
 subprojects/abseil-cpp.wrap | 68 ++++++++++++++++++++++++++++++++++---
 2 files changed, 76 insertions(+), 7 deletions(-)

diff --git a/meson.build b/meson.build
index 9529a1b..dfaf80f 100644
--- a/meson.build
+++ b/meson.build
@@ -59,14 +59,25 @@ absl_dep = [
   dependency('absl_flags'),
   dependency('absl_strings'),
   dependency('absl_synchronization'),
+  dependency('absl_bad_optional_access'),
 ]
 
+if absl_dep[0].type_name() == 'internal'
+  absl_subproj = subproject('abseil-cpp')
+  headers = [
+    absl_subproj.get_variable('absl_base_headers'),
+    absl_subproj.get_variable('absl_flags_headers'),
+    absl_subproj.get_variable('absl_strings_headers'),
+    absl_subproj.get_variable('absl_synchronization_headers'),
+    absl_subproj.get_variable('absl_types_headers'),
+  ]
+  install_headers(headers, preserve_path: true)
+endif
+
 if ['darwin', 'ios'].contains(host_system)
   os_cflags = ['-DWEBRTC_MAC']
   if host_system == 'ios'
     os_cflags += ['-DWEBRTC_IOS']
-    # For absl_bad_optional_access
-    absl_dep += [dependency('absl_types')]
   endif
   have_posix = true
 elif host_system == 'android'
diff --git a/subprojects/abseil-cpp.wrap b/subprojects/abseil-cpp.wrap
index 717b1e8..b2d6222 100644
--- a/subprojects/abseil-cpp.wrap
+++ b/subprojects/abseil-cpp.wrap
@@ -3,11 +3,11 @@ directory = abseil-cpp-20230125.1
 source_url = https://github.com/abseil/abseil-cpp/archive/20230125.1.tar.gz
 source_filename = abseil-cpp-20230125.1.tar.gz
 source_hash = 81311c17599b3712069ded20cca09a62ab0bf2a89dfa16993786c8782b7ed145
-patch_filename = abseil-cpp_20230125.1-1_patch.zip
-patch_url = https://wrapdb.mesonbuild.com/v2/abseil-cpp_20230125.1-1/get_patch
-patch_hash = a920ab28067e433d7ead2d564a4f511628f498f0723f7f94d19317877787ef39
-source_fallback_url = https://github.com/mesonbuild/wrapdb/releases/download/abseil-cpp_20230125.1-1/abseil-cpp-20230125.1.tar.gz
-wrapdb_version = 20230125.1-1
+patch_filename = abseil-cpp_20230125.1-4_patch.zip
+patch_url = https://wrapdb.mesonbuild.com/v2/abseil-cpp_20230125.1-4/get_patch
+patch_hash = 112ee72052049d930396c2778fc1c6e184137905dd75d60a97dcfc386426610d
+source_fallback_url = https://github.com/mesonbuild/wrapdb/releases/download/abseil-cpp_20230125.1-4/abseil-cpp-20230125.1.tar.gz
+wrapdb_version = 20230125.1-4
 
 [provide]
 absl_base = absl_base_dep
@@ -18,9 +18,67 @@ absl_flags = absl_flags_dep
 absl_hash = absl_hash_dep
 absl_crc = absl_crc_dep
 absl_numeric = absl_numeric_dep
+absl_profiling = absl_profiling_dep
 absl_random = absl_random_dep
 absl_status = absl_status_dep
 absl_strings = absl_strings_dep
 absl_synchronization = absl_synchronization_dep
 absl_time = absl_time_dep
 absl_types = absl_types_dep
+absl_bad_any_cast_impl = absl_types_dep
+absl_bad_optional_access = absl_types_dep
+absl_bad_variant_access = absl_types_dep
+absl_city = absl_hash_dep
+absl_civil_time = absl_time_dep
+absl_cord = absl_strings_dep
+absl_cord_internal = absl_strings_dep
+absl_cordz_functions = absl_strings_dep
+absl_cordz_handle = absl_strings_dep
+absl_cordz_info = absl_strings_dep
+absl_cordz_sample_token = absl_strings_dep
+absl_debugging_internal = absl_debugging_dep
+absl_demangle_internal = absl_debugging_dep
+absl_examine_stack = absl_debugging_dep
+absl_exponential_biased = absl_profiling_dep
+absl_failure_signal_handler = absl_debugging_dep
+absl_flags_commandlineflag = absl_flags_dep
+absl_flags_commandlineflag_internal = absl_flags_dep
+absl_flags_config = absl_flags_dep
+absl_flags_internal = absl_flags_dep
+absl_flags_marshalling = absl_flags_dep
+absl_flags_parse = absl_flags_dep
+absl_flags_private_handle_accessor = absl_flags_dep
+absl_flags_program_name = absl_flags_dep
+absl_flags_reflection = absl_flags_dep
+absl_flags_usage = absl_flags_dep
+absl_flags_usage_internal = absl_flags_dep
+absl_graphcycles_internal = absl_synchronization_dep
+absl_hashtablez_sampler = absl_container_dep
+absl_int128 = absl_numeric_dep
+absl_leak_check = absl_debugging_dep
+absl_log_severity = absl_base_dep
+absl_low_level_hash = absl_hash_dep
+absl_periodic_sampler = absl_profiling_dep
+absl_random_distributions = absl_random_dep
+absl_random_internal_distribution_test_util = absl_random_dep
+absl_random_internal_platform = absl_random_dep
+absl_random_internal_pool_urbg = absl_random_dep
+absl_random_internal_randen = absl_random_dep
+absl_random_internal_randen_hwaes = absl_random_dep
+absl_random_internal_randen_hwaes_impl = absl_random_dep
+absl_random_internal_randen_slow = absl_random_dep
+absl_random_internal_seed_material = absl_random_dep
+absl_random_seed_gen_exception = absl_random_dep
+absl_random_seed_sequences = absl_random_dep
+absl_raw_hash_set = absl_container_dep
+absl_raw_logging_internal = absl_base_dep
+absl_scoped_set_env = absl_base_dep
+absl_spinlock_wait = absl_base_dep
+absl_stacktrace = absl_debugging_dep
+absl_statusor = absl_status_dep
+absl_strerror = absl_base_dep
+absl_str_format_internal = absl_strings_dep
+absl_strings_internal = absl_strings_dep
+absl_symbolize = absl_debugging_dep
+absl_throw_delegate = absl_base_dep
+absl_time_zone = absl_time_dep
-- 
2.39.2

